# –ú–∏–Ω–∏-CRM –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–∏–¥–æ–≤

–ù–µ–±–æ–ª—å—à–æ–π —Å–µ—Ä–≤–∏—Å –Ω–∞ **FastAPI + SQLAlchemy + SQLite** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π (–ª–∏–¥–æ–≤) –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ —Å —É—á—ë—Ç–æ–º:

- –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –ª–∏–º–∏—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
- –≤–µ—Å–æ–≤ (–¥–æ–ª–µ–π —Ç—Ä–∞—Ñ–∏–∫–∞) –ø–æ –∫–∞–∂–¥–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É (–±–æ—Ç—É)

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∑–∞ ~1.5 —á–∞—Å–∞ —Å—Ç—Ä–æ–≥–æ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é.

---

## üß† –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

- –õ–∏–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –ø–æ–ª—é `external_id` (–Ω–∞–ø—Ä–∏–º–µ—Ä, Telegram ID, chat-id –∏ —Ç.–ø.) ‚Äî **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–Ω–∏–∫–∞–ª–µ–Ω**.
- –ù–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –µ–º—É –æ–±—Ä–∞—â–µ–Ω–∏–π (`Appeal.operator_id`).
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É **weighted random**:
  - –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å = `weight / sum_weights` —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö **–∞–∫—Ç–∏–≤–Ω—ã—Ö** –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞,
  - –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ `load < max_load`.
- –ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ—Ç ‚Äî –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è **–±–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞** (`operator_id = null`), **–æ—à–∏–±–∫–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è**.
- –í—Å–µ API-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Ç—Ä–µ–±—É–µ–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π) ‚Äî —á–µ—Ä–µ–∑ `run.py`

```bash
python -m venv venv
source venv/Scripts/activate    # Windows: venv\Scripts\activate
pip install -r requirements.txt
python run.py
```

---

### ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ `uvicorn`

```bash
uvicorn main:app --reload
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:

- API: http://127.0.0.1:8000
- Swagger UI: http://127.0.0.1:8000/docs

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ main.py              # –≤–µ—Å—å –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (FastAPI + –º–æ–¥–µ–ª–∏ + –ª–æ–≥–∏–∫–∞)
‚îú‚îÄ‚îÄ run.py               # —É–¥–æ–±–Ω—ã–π entrypoint –¥–ª—è –∑–∞–ø—É—Å–∫–∞
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ test.db              # —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (SQLite —Ñ–∞–π–ª)
‚îî‚îÄ‚îÄ README.md
```

---

## üóÇ –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

| –°—É—â–Ω–æ—Å—Ç—å | –ü–æ–ª—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|------|----------|
| **Operator** | id, name, is_active, max_load | –û–ø–µ—Ä–∞—Ç–æ—Ä |
| **Source** | id, name | –ë–æ—Ç / –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π |
| **OperatorSource** | operator_id, source_id, weight | –°–≤—è–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Üî –∏—Å—Ç–æ—á–Ω–∏–∫ + –≤–µ—Å |
| **Lead** | id, external_id *(unique)* | –ö–ª–∏–µ–Ω—Ç |
| **Appeal** | id, lead_id, source_id, operator_id *(nullable)*, timestamp, message | –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ |

---

## üîå –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã

- `POST   /operators/` ‚Äî —Å–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- `GET    /operators/` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫
- `PATCH  /operators/{id}` ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å `is_active` / `max_load`

---

### ü§ñ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (–±–æ—Ç—ã)

- `POST   /sources/` ‚Äî —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫
- `GET    /sources/` ‚Äî —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

---

### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

–ü—Ä–∏–≤—è–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É —Å –≤–µ—Å–æ–º:

```
POST /operator-sources/
```

```json
{
  "operator_id": 1,
  "source_id": 2,
  "weight": 70
}
```

---

### üì© –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è (–≥–ª–∞–≤–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç)

```
POST /appeals/
```

```json
{
  "external_id": "tg_123456789",
  "source_id": 1,
  "message": "–•–æ—á—É –∫—É–ø–∏—Ç—å –∫—É—Ä—Å"
}
```

‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º `operator_id` (–∏–ª–∏ `null`).

---

### üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö

- `GET /leads/` ‚Äî –≤—Å–µ –ª–∏–¥—ã —Å –∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
- `GET /appeals/` ‚Äî –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
- `GET /operator-sources/` ‚Äî –≤—Å–µ –ø—Ä–∏–≤—è–∑–∫–∏ (–¥–æ—Å—Ç—É–ø–µ–Ω —Ñ–∏–ª—å—Ç—Ä `?source_id=1`)

---

## ‚≠ê –ë–æ–Ω—É—Å—ã (–≤–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –¢–ó)

- –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ, –Ω–æ —Å –ª–æ–≥–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π —á–µ—Ä–µ–∑ `subquery + outer join`
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –ø—Ä–æ–µ–∫—Ç –º–∏–Ω–∏
- 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç—Ä–µ–±—É–µ–º–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é:
  - async
  - Alembic
  - Docker
  - —Ç–µ—Å—Ç—ã

---

‚úÖ –ü—Ä–æ–µ–∫—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–∏—Å—Ç—ã–π, —Ä–∞–±–æ—á–∏–π –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –≤ —Ä–∞–º–∫–∞—Ö 1‚Äì2 —á–∞—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

